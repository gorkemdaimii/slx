<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Åevvale Sevgilerle ğŸ’•</title>

    <!-- React + Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <link rel="manifest" href="/manifest.json" />

    <style>
        @keyframes envelopeOpen {
            0% { transform: rotateX(90deg); opacity: 0; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }

        @keyframes letterSlideUp {
            0% { transform: translateY(40px); opacity: 0; }
            60% { opacity: 1; }
            100% { transform: translateY(-10px); opacity: 1; }
        }

        @keyframes envelopeFlyAway {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            60% { transform: scale(0.85) translateY(-120px); }
            100% { transform: scale(0.6) translateY(-200px); opacity: 0; }
        }

        @keyframes modalOpen {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes filmEffect {
            0% { filter: contrast(0.8) brightness(0.9) blur(2px); }
            100% { filter: contrast(1) brightness(1) blur(0); }
        }

        .film-modal {
            animation: modalOpen 0.3s ease-out, filmEffect 0.4s ease-out;
        }
    </style>
</head>

<body class="bg-rose-300/40">
    <div id="root"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBzF_kGylIuZKu2DnlOuMc-cU3YJwTGCHA",
    authDomain: "sevvals-239d0.firebaseapp.com",
    projectId: "sevvals-239d0",
    storageBucket: "sevvals-239d0.firebasestorage.app",
    messagingSenderId: "727817694816",
    appId: "1:727817694816:web:7282a82008d29ee0665d05"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storage = firebase.storage();
const messaging = firebase.messaging();

// React deÄŸiÅŸkenlerini aÃ§Ä±yoruz
const { useState, useEffect } = React;
</script>
    <script type="text/babel">

/* --------------------------------------------------------
   FÄ°LM EFEKTÄ° FOTOÄRAF MODALI
-------------------------------------------------------- */
function PhotoModal({ url, onClose }) {
    if (!url) return null;

    return (
        <div 
            className="fixed inset-0 bg-black/70 backdrop-blur-md z-[9999] flex items-center justify-center p-4"
            onClick={onClose}
        >
            <img 
                src={url} 
                className="max-w-full max-h-full rounded-xl shadow-2xl film-modal"
            />
        </div>
    );
}

/* --------------------------------------------------------
   TAM EKRAN MEKTUP ANÄ°MASYONU (GÃ¶nderiliyor...)
-------------------------------------------------------- */
function FullscreenSendLetter({ text, onFinish }) {
    useEffect(() => {
        const t = setTimeout(() => onFinish(), 2300);
        return () => clearTimeout(t);
    }, []);

    return (
        <div className="fixed inset-0 flex items-center justify-center bg-rose-400/70 backdrop-blur-xl z-[9998]">
            <div className="relative flex flex-col items-center">

                <div
                    className="w-80 h-52 bg-white border border-rose-300 shadow-2xl rounded-md relative"
                    style={{ animation: "envelopeFlyAway 2s ease-out forwards", animationDelay: "1.1s" }}
                >
                    <div
                        className="absolute top-0 w-full h-28 bg-rose-200 border-b border-rose-300"
                        style={{
                            transformOrigin: "top",
                            animation: "envelopeOpen 1.3s ease-out forwards"
                        }}
                    ></div>
                </div>

                <div
                    className="absolute w-64 bg-white border border-rose-200 shadow-xl rounded-md p-4 text-center"
                    style={{ animation: "letterSlideUp 1.5s ease-out forwards", animationDelay: "0.4s" }}
                >
                    <p className="text-rose-500 font-bold text-lg mb-2">ğŸ’Œ GÃ¶nderiliyor...</p>
                    <p className="text-gray-700 whitespace-pre-wrap">{text}</p>
                </div>

            </div>
        </div>
    );
}

/* --------------------------------------------------------
   GÄ°ZLÄ° MESAJ (basÄ±lÄ± tutunca aÃ§Ä±lÄ±yor)
-------------------------------------------------------- */
function SecretText({ text }) {
    const [revealed, setRevealed] = useState(false);

    return (
        <p
            onMouseDown={() => setRevealed(true)}
            onMouseUp={() => setRevealed(false)}
            onMouseLeave={() => setRevealed(false)}
            onTouchStart={() => setRevealed(true)}
            onTouchEnd={() => setRevealed(false)}
            className="transition-all duration-300 select-none cursor-pointer mt-2"
            style={{
                filter: revealed ? "blur(0)" : "blur(6px)",
                opacity: revealed ? 1 : 0.6
            }}
        >
            {text}
        </p>
    );
}

/* --------------------------------------------------------
   MESAJ SÄ°STEMÄ° (Foto + Zaman KapsÃ¼lÃ¼ + Gizli Mesaj)
-------------------------------------------------------- */
function MessageWall() {
    const [messages, setMessages] = useState([]);
    const [senderName, setSenderName] = useState("");
    const [newMessage, setNewMessage] = useState("");
    const [secretMode, setSecretMode] = useState(false);
    const [capsuleDate, setCapsuleDate] = useState("");

    const [photos, setPhotos] = useState([]); // seÃ§ili foto dosyalarÄ±
    const [sendingAnim, setSendingAnim] = useState(false);
    const [tempText, setTempText] = useState("");

    const [modalPhoto, setModalPhoto] = useState(null);

    const now = new Date();

    /* Firestore listener */
    useEffect(() => {
        const unsub = db.collection("messages")
            .orderBy("timestamp", "desc")
            .onSnapshot((snapshot) => {
                setMessages(snapshot.docs.map(doc => ({
                    id: doc.id, 
                    ...doc.data()
                })));
            });

        return () => unsub();
    }, []);

    /* FOTOÄRAF SEÃ‡ME */
    const handlePhotoSelect = (e) => {
        setPhotos([...e.target.files]); // Ã§oklu foto desteÄŸi
    };

    /* FOTOÄRAF UPLOAD + MESAJ GÃ–NDERME */
    const sendMessage = async () => {
        if (!senderName.trim() || (!newMessage.trim() && photos.length === 0)) return;

        setTempText(newMessage);
        setSendingAnim(true);

        // FotoÄŸraflar Storage'a yÃ¼kleniyor â†’ URL listesi oluÅŸturuluyor
        const photoURLs = [];

        for (const file of photos) {
            const ref = storage.ref(`photos/${Date.now()}_${file.name}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            photoURLs.push(url);
        }

        await db.collection("messages").add({
            sender: senderName,
            text: newMessage,
            photos: photoURLs, // ğŸ”¥ foto URL listesini kaydediyoruz
            secret: secretMode,
            openAt: capsuleDate ? new Date(capsuleDate) : null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            color: `hsl(${Math.random() * 360}, 70%, 65%)`
        });

        setNewMessage("");
        setSecretMode(false);
        setCapsuleDate("");
        setPhotos([]);
    };

    const deleteMessage = async (id) => {
        await db.collection("messages").doc(id).delete();
    };

    return (
        <div className="max-w-2xl mx-auto pb-10">

            {/* GÃ–NDERÄ°LÄ°YOR ANÄ°MASYONU */}
            {sendingAnim && (
                <FullscreenSendLetter
                    text={tempText}
                    onFinish={() => setSendingAnim(false)}
                />
            )}

            {/* MESAJ YAZMA ALANI */}
            <div className="bg-white p-5 rounded-2xl shadow-xl mb-6">
                
                <input
                    type="text"
                    placeholder="Ä°smin ğŸ’•"
                    className="w-full border p-3 rounded-xl mb-3"
                    value={senderName}
                    onChange={(e)=>setSenderName(e.target.value)}
                />

                <textarea
                    placeholder="MesajÄ±n ğŸ’Œ"
                    className="w-full border p-3 rounded-xl mb-3"
                    rows="3"
                    value={newMessage}
                    onChange={(e)=>setNewMessage(e.target.value)}
                />

                {/* ğŸ“ FOTOÄRAF EKLE */}
                <label className="flex items-center gap-3 cursor-pointer mb-3">
                    <span className="bg-rose-500 text-white px-3 py-2 rounded-xl text-sm">
                        ğŸ“ FotoÄŸraf Ekle
                    </span>
                    <input 
                        type="file"
                        accept="image/*"
                        multiple
                        className="hidden"
                        onChange={handlePhotoSelect}
                    />
                </label>

                {/* YÃœKLENEN FOTO Ã–NÄ°ZLEMESÄ° */}
                {photos.length > 0 && (
                    <div className="flex gap-2 flex-wrap mb-3">
                        {photos.map((p, i) => (
                            <p className="text-xs bg-gray-100 px-2 py-1 rounded" key={i}>
                                {p.name}
                            </p>
                        ))}
                    </div>
                )}

                {/* Gizli mesaj */}
                <label className="flex items-center gap-2 mb-3">
                    <input 
                        type="checkbox"
                        checked={secretMode}
                        onChange={() => setSecretMode(!secretMode)}
                    />
                    <span className="text-gray-700">ğŸ”’ Gizli mesaj (basÄ±lÄ± tutarak aÃ§Ä±lÄ±r)</span>
                </label>

                {/* Zaman kapsÃ¼lÃ¼ */}
                <label className="block mb-4">
                    <span className="text-gray-700">â³ Zaman kapsÃ¼lÃ¼</span>
                    <input 
                        type="datetime-local"
                        className="w-full border p-2 rounded-xl mt-1"
                        value={capsuleDate}
                        onChange={(e)=>setCapsuleDate(e.target.value)}
                    />
                </label>

                <button
                    onClick={sendMessage}
                    className="w-full bg-rose-500 hover:bg-rose-600 text-white p-3 rounded-xl font-bold"
                >
                    GÃ¶nder
                </button>
            </div>

            {/* MESAJ LÄ°STESÄ° */}
            <div className="space-y-4">
                {messages.map(msg => {
                    const openAt = msg.openAt?.toDate ? msg.openAt.toDate() : null;
                    const locked = openAt && new Date() < openAt;

                    return (
                        <div key={msg.id} className="bg-white p-5 rounded-2xl shadow-xl">

                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-bold" style={{ color: msg.color }}>
                                        {msg.sender}
                                    </p>
                                    <p className="text-gray-500 text-sm">
                                        {msg.timestamp?.toDate().toLocaleString("tr-TR")}
                                    </p>
                                </div>

                                <button 
                                    onClick={() => deleteMessage(msg.id)}
                                    className="text-red-500 hover:text-red-700 text-xl"
                                >
                                    ğŸ—‘ï¸
                                </button>
                            </div>

                            {/* ZAMAN KAPSÃœLÃœ KÄ°LÄ°TLÄ° */}
                            {locked && (
                                <p className="text-gray-600 mt-3">
                                    â³ Bu mektup <b>{openAt.toLocaleString("tr-TR")}</b> tarihinde aÃ§Ä±lacak ğŸ’Œ
                                </p>
                            )}

                            {/* METÄ°N (gizli veya normal) */}
                            {!locked && (
                                msg.secret ? (
                                    <SecretText text={msg.text} />
                                ) : (
                                    <p className="text-gray-800 whitespace-pre-wrap mt-2">
                                        {msg.text}
                                    </p>
                                )
                            )}

                            {/* FOTOÄRAFLAR (mesajÄ±n iÃ§eriÄŸi gÃ¶rÃ¼nmesin istedin â†’ sadece "FotoÄŸrafÄ± AÃ§" butonu) */}
                            {!locked && msg.photos && msg.photos.length > 0 && (
                                <div className="mt-4">
                                    {msg.photos.map((url, i) => (
                                        <button
                                            key={i}
                                            onClick={() => setModalPhoto(url)}
                                            className="bg-gray-100 border border-gray-300 px-3 py-2 rounded-xl text-sm hover:bg-gray-200"
                                        >
                                            ğŸ“· FotoÄŸrafÄ± AÃ§ ({i+1})
                                        </button>
                                    ))}
                                </div>
                            )}

                        </div>
                    );
                })}
            </div>

            {/* FOTO MODAL */}
            <PhotoModal url={modalPhoto} onClose={() => setModalPhoto(null)} />
        </div>
    );
}
/* --------------------------------------------------------
   HOÅ GELDÄ°N PRENSESÄ°M AÃ‡ILIÅ EKRANI
-------------------------------------------------------- */
function WelcomeOverlay({ onClose }) {
    useEffect(() => {
        const t = setTimeout(() => onClose(), 2200);
        return () => clearTimeout(t);
    }, []);

    return (
        <div className="fixed inset-0 bg-rose-300/60 backdrop-blur-xl z-[9997] flex items-center justify-center">
            <h1 className="text-white text-4xl sm:text-5xl font-bold text-center"
                style={{ animation: "welcomeFade 1.5s ease-out forwards" }}>
                ğŸ’• HoÅŸ geldin prensesim ğŸ’•
            </h1>
        </div>
    );
}

/* --------------------------------------------------------
   ANA APP WRAPPER
-------------------------------------------------------- */
function App() {
    const [showWelcome, setShowWelcome] = useState(false);
    const [pushReady, setPushReady] = useState(false);

    // HoÅŸ geldin ekranÄ± sadece 1 kez
    useEffect(() => {
        if (!localStorage.getItem("sevval_welcome_shown")) {
            setShowWelcome(true);
            localStorage.setItem("sevval_welcome_shown", "yes");
        }
    }, []);

    // Service Worker kayÄ±tlÄ± mÄ± kontrol et
    useEffect(() => {
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/firebase-messaging-sw.js")
                .then(() => setPushReady(true))
                .catch(() => setPushReady(false));
        }
    }, []);

    async function enableNotifications() {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
            alert("Bildirim izni verilmedi.");
            return;
        }

        const vapidKey = "BURAYA_WEB_PUSH_PUBLIC_KEY_GELECEK";

        const token = await messaging.getToken({ vapidKey });
        if (token) {
            await db.collection("notificationTokens").doc(token).set({
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Bildirimler aktif ğŸ’Œ");
        } else {
            alert("Token alÄ±namadÄ±.");
        }
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-rose-400 via-pink-500 to-purple-600 p-6">

            {/* HOÅ GELDÄ°N EKRANI */}
            {showWelcome && (
                <WelcomeOverlay onClose={() => setShowWelcome(false)} />
            )}

            {/* HEADER */}
            <div className="max-w-2xl mx-auto bg-white/30 backdrop-blur-xl p-6 rounded-3xl text-center mb-6 shadow-xl">
                <h1 className="text-white text-5xl font-bold">
                    Åevvale Sevgilerle ğŸ’•
                </h1>
                <p className="text-white/90 mt-2">
                    Sana Ã¶zel mektuplar ve anÄ±lar burada ğŸŒ¸
                </p>
            </div>

            {/* BÄ°LDÄ°RÄ°M BUTONU */}
            {pushReady && (
                <div className="max-w-2xl mx-auto mb-4 text-center">
                    <button
                        onClick={enableNotifications}
                        className="bg-white/30 backdrop-blur-lg px-4 py-2 rounded-xl 
                        text-white font-semibold hover:bg-white/40">
                        ğŸ”” Bildirimleri AÃ§
                    </button>
                </div>
            )}

            {/* ANA MESAJ SÄ°STEMÄ° */}
            <MessageWall />
        </div>
    );
}

/* --------------------------------------------------------
   REACT RENDER
-------------------------------------------------------- */
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>

</body>
</html>
